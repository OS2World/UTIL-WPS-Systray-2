____________________________________________________________

 Systray/2                          Revison 0.1 (20/07/2000)
 Plugin making reference.           
____________________________________________________________
                                   Team OS/2 Russian project




 1. Предисловие

 Внимание! В  данном  документе  описывается предварительная
 версия интерфейса для создания  плагинов.  В  окончательной
 версии программы возможно ее изменение.



 2. Соглашения о представлении данных

 В данном описании используется синтаксис языка Си. 



 3. Описане формата плагинов.


 3.1. Введение

 Внешние плагины    (plug-ins)    содержатся    во   внешних
 динамических  библиотеках  (Dll)   и   загружаются   средой
 Systray.   Поскольку  в  один  момент  времени  может  быть
 загруженно несколько  сред  (это  допускается,  т.к.  могут
 использоватся    различные    файлы    инициализации),   то
 разработчику необходимо предусмотреть данную возможность.


 3.2. Инициализация

 Инициализация плагина      происходит      при     загрузке
 экспортируемой функции RegisterPluginProc.  При этом данной
 процедуре передаются следующие параметры:

 BOOL EXPENTRY RegisterPluginProc (

 HMODULE hSelf, // дескриптор загрудаемого плагина
 HAB     hab,   // якорь
 PWCLASS pwc,   // список содержащихся классов окон (см.ниже)
 PUSHORT pus    // максимальное количество принимаемых классов
 );

 При этом данной  функции необходимо зарегистрировать классы
 окон и заполнить соответствующим образом структуру  pwc,  а
 также  занести  в  переменную pus количество экспортируемых
 классов.


 3.3. Структура списка классов PWCLASS

 typedef struct _WCLASS {
 CHAR    szName[250]; // имя оконного класса
 ULONG   ulCfgSize;   // размер кофигурации класса 
                      //(может менятся в процессе работы)
 ULONG   ulSafeAlloc; // размер выделяемой памяти для 
                      // конфигурации класса
 BYTE    bInitalUnitWidthPercent;
                      // начальная ширина окна в процентах
 } WCLASS;

 typedef WCLASS *PWCLASS;


 3.4. Пример инициализации оконного класса

 strcpy(pwc->szName,szClassName);
 pwc->ulCfgSize = sizeof(UNIT);
 pwc->ulSafeAlloc = sizeof(UNIT);
 pwc->bInitalUnitWidthPercent = 15;
 WinRegisterClass(hab,(PSZ)szClassName,
                        (PFNWP)classwndproc,CS_SIZEREDRAW,8L);

 *pus = 1;


 3.5. Спецификация модулей

 Модули (Unit)  -  базовый  элемент  построения  панели  для
 Systray.   В   нем   может   содержатся  любая  информация,
 соответствующая классу его окна.  Каждому отдельному модулю
 соответствует   своя   конфигурация.  При  этом  существует
 минимальная стандартная конфигурация содержащая в структуре
 UNIT:

 typedef struct _UNIT {
 ULONG   cbFix;		// ПОЛНЫЙ размер структуры
 CHAR    szClass[MAX_CLASS]; // имя класса
 CHAR    szBubble[MAX_CLASS]; // тест для подсказки
 HWND    hwnd; // дескриптор окна
 SHORT   sFlags; // не используется, зарезервировано
 ULONG   ulRefresh; // используется индивидуально
 SHORT   sBottom,sLeft,sHeight,sWidth; // используется внутри Systray
 ULONG   ulReserved[4]; // зарезервировано, используется внутри Systray
 PFNWP   pfnOld; // не используется, зарезервировано
 } UNIT;
 typedef UNIT *PUNIT;

 При этом  указатель  на  структуру  передается при создании
 окна модуля.

 case WM_CREATE:

 punit = (PUNIT) mp1;
 WinSetWindowULong(hwnd, 0L, (ULONG)punit);
 break;

 при уничтожении должна быть освобождена память под него

 case WM_DESTROY:

 DosFree((PVOID)punit);
 break;

 Класс окна   модуля   может   использовать   дополнительное
 пространство  памяти  при  указании числа в соответствующем
 поле  структуры  WCLASS.   Начальный   размер   (минимально
 возможный) также указывается. При этом поле cbFix структуры
 UNIT может менятся  в  процессе  работы,  и  должно  всегда
 содержать размер  используемой  памяти  данным модулем т.к.
 используется при записи конфигурации.


 3.6. Настройка модулей.

 Настройка модулей  требуется  когда  пользователь  выбирает
 "Configure" в меню "Units...".  При  этом  соответствующему
 модулю  посылается  сообщение WM_COMMAND.  В mp1 содержится
 100,  а в mp2 - дескриптор  окна,  требуемый  для  указания
 владельца параметра   функции  WinDlgBox.  Если  модуль  не
 предусматривет   настройки,   то   это   сообщение    можно
 игнорировать.
 


 4. Контакты

 Автор программы: 	Дмитрий Захаров, madint@os2.ru
 WWW страница проекта:	http://os2.ru/projects/systray
 Russian Team OS/2:     http://os2.ru


____________________________________________________________
Copyright (с) 1999-2000   Dmitry Zakharov, Team OS/2 Russian
